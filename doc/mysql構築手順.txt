
--------------------------------------------------------------
単純インストール
--------------------------------------------------------------

-- on amazon linux 1

$ sudo yum install -y mysql57-server
$ mysqld --version

mysqld  Ver 5.7.24 for Linux on x86_64 (MySQL Community Server (GPL))

--------------------------------------------------------------
起動/停止
--------------------------------------------------------------

-- 自動起動
sudo chkconfig mysqld on

-- 起動
sudo service mysqld start

-- 停止
sudo service mysqld stop

--------------------------------------------------------------
参考: config
--------------------------------------------------------------

# -- 場所
# $ mysql --help | grep my.cnf
# /etc/my.cnf /etc/mysql/my.cnf ~/.my.cnf
# -> /etc/my.cnfのみ存在
# 
# -- 明示されているデフォルト値
# $ cat /etc/my.cnf | grep -v '#'
# 
# [mysqld]
# datadir=/var/lib/mysql
# socket=/var/lib/mysql/mysql.sock
# symbolic-links=0
# 
# [mysqld_safe]
# log-error=/var/log/mysqld.log
# pid-file=/var/run/mysqld/mysqld.pid

--------------------------------------------------------------
参考: SQL発行ログ
--------------------------------------------------------------

# -- /var/logはroot権限なので、dataファイルがある場所の方がよい
# 
# $ mysql --help | grep my.cnf
# 
# [mysqld]
# 
# general_log=1
# general_log_file=/var/lib/mysql/general_log.log

--------------------------------------------------------------
データファイル
--------------------------------------------------------------

-- 面倒なので、/dataにシンボリックリンクを貼る
$ sudo ln -s /var/lib/mysql /data

--------------------------------------------------------------
DB、サンプルユーザ、テーブルの作成
--------------------------------------------------------------

$ sudo service mysqld start

-- DBとユーザの作成

$ mysql -u root -p

create database template;
CREATE USER 'template'@'localhost' IDENTIFIED BY 'template';
grant ALL PRIVILEGES on template.* TO 'template'@'localhost';
FLUSH PRIVILEGES;

use template

create table test(id int(11));
insert into test values(1);
insert into test values(2);
select * from test;

--------------------------------------------------------------
DBをmasterにする
--------------------------------------------------------------

-- バイナリログの有効化とserver_idの付与

$ sudo vi /etc/my.cnf
[mysqld]
...

# master
log-bin
server-id=101

$ sudo service mysqld restart

$ ll /data/

以下のバイナリログが生成されるようになる
....
-rw-r----- 1 mysql mysql      154 Dec 12 06:31 ip-172-31-3-52-bin.000001
-rw-r----- 1 mysql mysql       28 Dec 12 06:31 ip-172-31-3-52-bin.index
...

-- slave接続用アカウントの作成

$ slave接続用アカウントを作成する

サブネットのIPv4 CIDRで作成する

$ mysql -u root -p

create user 'repl'@'172.31.0.0/255.255.240.0' identified by 'repl';
grant replication slave on *.* to 'repl'@'172.31.0.0/255.255.240.0';

-- 完全バックアップを取得する

$ mysqldump --master-data=2 --single-transaction -u root -p template > template.dump

* master-dataは取得時のバイナリログのポジションを出力する
* single-transactionを指定すると、dumpの取得時にロックをかける

--------------------------------------------------------------
slaveを作る
--------------------------------------------------------------

-- DBを作成する
$ sudo yum install -y mysql57-server
$ mysqld --version
$ sudo chkconfig mysqld on
$ sudo service mysqld start
$ sudo ln -s /var/lib/mysql /data

-- サーバIDを振る
masterと重複しないこと

$ sudo vi /etc/my.cnf
[mysqld]
...

# slave
server-id=102

-- 再起動
service mysqld restart

-- dumpのコピー
$ cd /home/ec2-user
$ {持ってくる}

-- DBの作成
$ mysql -u root -p
mysql> create database template;
mysql> use template
mysql> source template.dump
mysql> select * from test;

-- log_fileとlog_posを確認する
$ grep MASTER_LOG_FILE template.dump
CHANGE MASTER TO MASTER_LOG_FILE='ip-172-31-14-224-bin.000001', MASTER_LOG_POS=641;

-- masterに接続する

$ mysql -u root -p

change master to 
master_host='172.31.14.224',
master_log_file='ip-172-31-14-224-bin.000001',
master_log_pos=641;

start slave user = 'repl' password = 'repl';

mysql> show slave status;
+----------------------------------+-------------+-------------+-------------+---------------+---------------------------+---------------------+----------------------------------+---------------+---------------------------+------------------+-------------------+-----------------+---------------------+--------------------+------------------------+-------------------------+-----------------------------+------------+------------+--------------+---------------------+-----------------+-----------------+----------------+---------------+--------------------+--------------------+--------------------+-----------------+-------------------+----------------+-----------------------+-------------------------------+---------------+---------------+----------------+----------------+-----------------------------+------------------+--------------------------------------+----------------------------+-----------+---------------------+--------------------------------------------------------+--------------------+-------------+-------------------------+--------------------------+----------------+--------------------+--------------------+-------------------+---------------+----------------------+--------------+--------------------+
| Slave_IO_State                   | Master_Host | Master_User | Master_Port | Connect_Retry | Master_Log_File           | Read_Master_Log_Pos | Relay_Log_File                   | Relay_Log_Pos | Relay_Master_Log_File     | Slave_IO_Running | Slave_SQL_Running | Replicate_Do_DB | Replicate_Ignore_DB | Replicate_Do_Table | Replicate_Ignore_Table | Replicate_Wild_Do_Table | Replicate_Wild_Ignore_Table | Last_Errno | Last_Error | Skip_Counter | Exec_Master_Log_Pos | Relay_Log_Space | Until_Condition | Until_Log_File | Until_Log_Pos | Master_SSL_Allowed | Master_SSL_CA_File | Master_SSL_CA_Path | Master_SSL_Cert | Master_SSL_Cipher | Master_SSL_Key | Seconds_Behind_Master | Master_SSL_Verify_Server_Cert | Last_IO_Errno | Last_IO_Error | Last_SQL_Errno | Last_SQL_Error | Replicate_Ignore_Server_Ids | Master_Server_Id | Master_UUID                          | Master_Info_File           | SQL_Delay | SQL_Remaining_Delay | Slave_SQL_Running_State                                | Master_Retry_Count | Master_Bind | Last_IO_Error_Timestamp | Last_SQL_Error_Timestamp | Master_SSL_Crl | Master_SSL_Crlpath | Retrieved_Gtid_Set | Executed_Gtid_Set | Auto_Position | Replicate_Rewrite_DB | Channel_Name | Master_TLS_Version |
+----------------------------------+-------------+-------------+-------------+---------------+---------------------------+---------------------+----------------------------------+---------------+---------------------------+------------------+-------------------+-----------------+---------------------+--------------------+------------------------+-------------------------+-----------------------------+------------+------------+--------------+---------------------+-----------------+-----------------+----------------+---------------+--------------------+--------------------+--------------------+-----------------+-------------------+----------------+-----------------------+-------------------------------+---------------+---------------+----------------+----------------+-----------------------------+------------------+--------------------------------------+----------------------------+-----------+---------------------+--------------------------------------------------------+--------------------+-------------+-------------------------+--------------------------+----------------+--------------------+--------------------+-------------------+---------------+----------------------+--------------+--------------------+
| Waiting for master to send event | 172.31.3.52 | repl        |        3306 |            60 | ip-172-31-3-52-bin.000001 |                1627 | ip-172-31-7-174-relay-bin.000002 |           329 | ip-172-31-3-52-bin.000001 | Yes              | Yes               |                 |                     |                    |                        |                         |                             |          0 |            |            0 |                1627 |             546 | None            |                |             0 | No                 |                    |                    |                 |                   |                |                     0 | No                            |             0 |               |              0 |                |                             |              101 | 26df82ed-fdd5-11e8-a128-0678fe67d0a8 | /var/lib/mysql/master.info |         0 |                NULL | Slave has read all relay log; waiting for more updates |              86400 |             |                         |                          |                |                    |                    |                   |             0 |                      |              |                    |
+----------------------------------+-------------+-------------+-------------+---------------+---------------------------+---------------------+----------------------------------+---------------+---------------------------+------------------+-------------------+-----------------+---------------------+--------------------+------------------------+-------------------------+-----------------------------+------------+------------+--------------+---------------------+-----------------+-----------------+----------------+---------------+--------------------+--------------------+--------------------+-----------------+-------------------+----------------+-----------------------+-------------------------------+---------------+---------------+----------------+----------------+-----------------------------+------------------+--------------------------------------+----------------------------+-----------+---------------------+--------------------------------------------------------+--------------------+-------------+-------------------------+--------------------------+----------------+--------------------+--------------------+-------------------+---------------+----------------------+--------------+--------------------+
1 row in set (0.00 sec)






